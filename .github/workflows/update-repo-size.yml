name: Rebuild README with repo size

on:
  schedule:
    - cron: '0 0,4,8,12,16,20 * * *'  # cada 4 horas (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rebuild-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get repository size (KB) from GitHub API
        id: get_size
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          api_url="https://api.github.com/repos/${REPO}"
          size_kb=$(curl -s -H "Authorization: token ${TOKEN}" "$api_url" | jq -r .size)
          size_mb=$(awk "BEGIN {printf \"%.2f\", ${size_kb}/1024}")
          echo "size_mb=${size_mb}" >> $GITHUB_OUTPUT

      - name: Rebuild README.md
        run: |
          SIZE="${{ steps.get_size.outputs.size_mb }}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          echo "# Maldiciones" > README.md
          echo "" >> README.md
          echo "[https://kudomarkos.github.io/maldiciones/](https://kudomarkos.github.io/maldiciones/)" >> README.md
          echo "" >> README.md
          echo "![logo](./static_images/logo_maldiciones.png)" >> README.md
          echo "" >> README.md
          echo "## Tamaño del Repositorio" >> README.md
          echo "El tamaño de este repositorio es aproximadamente ${SIZE} MB. (Actualizado: ${NOW})" >> README.md

      - name: Commit and push changes
        run: |
          SIZE="${{ steps.get_size.outputs.size_mb }}"
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add README.md
          git commit -m "chore: rebuild README with repo size $SIZE MB [ci skip]"
          git push
